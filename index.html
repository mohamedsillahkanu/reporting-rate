<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICF-SL Reporting Rate Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { margin: 0; padding: 20px; background-color: #ffffff; font-family: 'Oswald', Arial, sans-serif; color: #000000; font-weight: 500; }
        .page-container { width: 100%; max-width: 1400px; margin: 0 auto; }
        .page-header { background-color: #004080; color: #ffffff; padding: 25px 30px; text-align: center; margin-bottom: 15px; border-radius: 8px 8px 0 0; }
        .logo-row { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 15px; }
        .logo-box { background: #ffffff; border-radius: 8px; padding: 10px; display: flex; align-items: center; justify-content: center; }
        .logo-box img { width: 100px; height: auto; border-radius: 6px; }
        .page-header h3 { margin: 12px 0 5px; font-size: 14px; font-weight: 700; letter-spacing: 1px; color: #ffffff; }
        .page-header .tagline { margin: 0; font-size: 10px; font-weight: 500; color: #ffffff; }
        .page-header h1 { margin: 20px 0 10px; font-size: 24px; font-weight: 700; color: #ffffff; letter-spacing: 1px; }
        .page-header .subtitle { font-size: 14px; color: #ffffff; font-weight: 500; }
        .content-card { border: 4px double #004080; border-radius: 12px; padding: 12px; background-color: #ffffff; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 15px; }
        .content-inner { padding: 25px; }
        .upload-section { background: #f8f9fa; padding: 2rem; border-radius: 8px; border: 2px dashed #004080; text-align: center; margin: 1.5rem 0; transition: all 0.3s ease; }
        .upload-section:hover { border-color: #0056b3; background: #e7f3ff; }
        .upload-section h3 { color: #004080; margin-bottom: 1rem; font-size: 18px; font-weight: 700; }
        .upload-section p { color: #000000; font-weight: 500; font-size: 14px; }
        .file-input-wrapper { position: relative; display: inline-block; cursor: pointer; background: #004080; color: white; padding: 14px 24px; border-radius: 6px; border: 2px solid #004080; font-size: 14px; font-weight: 700; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; font-family: 'Oswald', Arial, sans-serif; margin-top: 1rem; }
        .file-input-wrapper:hover { background: #0056b3; border-color: #0056b3; }
        .file-input-wrapper input[type="file"] { position: absolute; left: -9999px; }
        .section-header { background-color: #004080; color: #ffffff; padding: 15px 20px; margin-bottom: 20px; border-radius: 6px; display: flex; align-items: center; gap: 15px; }
        .section-icon { background: #ffffff; color: #004080; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; flex-shrink: 0; }
        .section-title { font-size: 18px; font-weight: 700; letter-spacing: 0.5px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
        .stats-card { background: #f8f9fa; padding: 1.25rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); text-align: center; border: 2px solid #004080; transition: all 0.2s; }
        .stats-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0, 64, 128, 0.2); }
        .stats-card h4 { color: #666; font-size: 10px; margin-bottom: 0.5rem; text-transform: uppercase; }
        .stats-card .metric-value { font-size: 1.6rem; color: #004080; margin-bottom: 0.25rem; font-weight: 700; }
        .stats-card p { color: #666; font-size: 10px; }
        .btn { padding: 14px 24px; border: 2px solid #004080; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; font-family: 'Oswald', Arial, sans-serif; transition: all 0.2s; margin: 5px; }
        .btn-primary { background: #004080; color: #ffffff; }
        .btn-primary:hover { background: #0056b3; border-color: #0056b3; }
        .btn-secondary { background: #ffffff; color: #004080; }
        .btn-secondary:hover { background: #004080; color: #ffffff; }
        .btn-success { background: #28a745; color: #ffffff; border-color: #28a745; }
        .btn-success:hover { background: #218838; border-color: #218838; }
        .btn-gold { background: #ffc107; color: #000; border-color: #ffc107; }
        .btn-gold:hover { background: #e0a800; border-color: #e0a800; }
        .alert { padding: 1rem; border-radius: 6px; margin: 1rem 0; font-weight: 500; }
        .alert-success { background: #d4edda; border: 2px solid #28a745; color: #155724; }
        .alert-error { background: #f8d7da; border: 2px solid #dc3545; color: #721c24; }
        .alert-info { background: #e7f3ff; border: 2px solid #004080; color: #004080; }
        .hidden { display: none !important; }
        .config-card { background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border: 2px solid #004080; margin: 1rem 0; }
        .config-card h4 { color: #004080; margin-bottom: 1rem; font-size: 16px; font-weight: 700; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 700; color: #004080; font-size: 13px; }
        .form-control { width: 100%; padding: 0.75rem 1rem; border: 2px solid #004080; border-radius: 6px; font-size: 14px; background: #ffffff; color: #000000; font-family: 'Oswald', Arial, sans-serif; font-weight: 500; }
        .form-control:focus { outline: none; border-color: #0056b3; box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.1); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.25rem; }
        .loading-spinner { border: 4px solid #e7f3ff; border-top: 4px solid #004080; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .step-box { background: #e7f3ff; border: 2px solid #004080; border-radius: 8px; padding: 1rem; margin: 0.75rem 0; }
        .step-box h5 { color: #004080; font-size: 13px; margin-bottom: 0.5rem; }
        .step-box p { color: #000; font-size: 12px; line-height: 1.6; }
        .step-box code { background: #fff; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 11px; color: #004080; }
        .page-footer { background-color: #004080; color: #ffffff; padding: 20px 30px; text-align: center; font-size: 13px; line-height: 1.7; font-weight: 500; border-radius: 0 0 8px 8px; }
        .page-footer p { margin: 6px 0 0; font-size: 12px; color: #ffffff; }
        .chart-container { background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border: 2px solid #004080; margin: 1.5rem 0; text-align: center; overflow-x: auto; }
        .heatmap-canvas { border-radius: 8px; background: #ffffff; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border: 2px solid #004080; display: block; margin: 0 auto; max-width: 100%; }
        .palette-selector { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin: 1rem 0; }
        .palette-option { background: #f8f9fa; padding: 0.75rem; border-radius: 8px; border: 2px solid #ddd; cursor: pointer; transition: all 0.2s; text-align: center; }
        .palette-option:hover { border-color: #004080; }
        .palette-option.selected { border-color: #28a745; background: #d4edda; }
        .palette-option input[type="radio"] { display: none; }
        .palette-preview { display: flex; justify-content: center; gap: 2px; margin-bottom: 0.5rem; height: 16px; }
        .palette-preview .color-box { flex: 1; border-radius: 2px; }
        .palette-name { font-size: 11px; font-weight: 700; color: #004080; }
        .output-list { background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 2px solid #004080; }
        .output-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid #ddd; }
        .output-item:last-child { border-bottom: none; }
        .output-item span { font-size: 13px; color: #000; }
        .output-item .btn { padding: 8px 16px; font-size: 12px; margin: 0; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 0.5rem; }
        .checkbox-item { display: flex; align-items: center; gap: 0.5rem; }
        .checkbox-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: #004080; }
        .checkbox-item label { font-size: 13px; color: #000; font-weight: 500; cursor: pointer; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f8f9fa; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #004080; border-radius: 4px; }
        @media (max-width: 768px) { body { padding: 10px; } .content-inner { padding: 15px; } .page-header h1 { font-size: 20px; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <div class="logo-row">
                <div class="logo-box">
                    <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL Logo">
                </div>
            </div>
            <h3>Informatics Consultancy Firm-Sierra Leone<br>(ICF-SL)</h3>
            <p class="tagline"><em>Driving Data-Driven Solutions for Health and Development</em></p>
            <h1>REPORTING RATE CALCULATOR</h1>
            <p class="subtitle">Calculate and Visualize Health Facility Reporting Rates</p>
        </div>

        <div class="content-card">
            <div class="content-inner">
                <div id="alertContainer"></div>

                <!-- Upload Section -->
                <div id="uploadSection">
                    <div class="upload-section">
                        <h3>UPLOAD YOUR DATA FILE</h3>
                        <p>Upload a CSV or Excel file with health facility reporting data</p>
                        <label class="file-input-wrapper">
                            Choose File
                            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
                        </label>
                        <div id="loading" class="hidden" style="margin-top: 1rem;">
                            <div class="loading-spinner"></div>
                            <p style="color: #004080; font-weight: 700;">Processing file...</p>
                        </div>
                    </div>

                    <div class="section-header">
                        <span class="section-icon">?</span>
                        <span class="section-title">CALCULATION METHODOLOGY</span>
                    </div>

                    <div class="step-box">
                        <h5>Step 1: Calculate Overall Reporting Indicator</h5>
                        <p>For each row: <code>report = 1</code> if SUM of indicator columns &gt; 0, else <code>report = 0</code></p>
                    </div>

                    <div class="step-box">
                        <h5>Step 2: Split Facilities</h5>
                        <p>Separate facilities that have at least one report from those with no reports ever</p>
                    </div>

                    <div class="step-box">
                        <h5>Step 3: Calculate Confirmed Reporting Indicator</h5>
                        <p>For each row: <code>report_conf = 1</code> if confirmed cases &gt; 0, else <code>report_conf = 0</code></p>
                    </div>

                    <div class="step-box">
                        <h5>Step 4: Determine Expected Reporting</h5>
                        <p>Find first month each facility reported. <code>expected = 1</code> for all months from first report onwards</p>
                    </div>

                    <div class="step-box">
                        <h5>Step 5: Calculate Reporting Rate</h5>
                        <p><code>Reporting Rate = (SUM of report_conf / SUM of expected) × 100</code></p>
                    </div>
                </div>

                <!-- Column Selection Section -->
                <div id="columnSection" class="hidden">
                    <div class="section-header">
                        <span class="section-icon">1</span>
                        <span class="section-title">SELECT COLUMNS</span>
                    </div>

                    <div class="stats-grid" id="dataStats"></div>

                    <div class="config-card">
                        <h4>Geographic Columns</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="locationColumn">Location Column (for aggregation)</label>
                                <select id="locationColumn" class="form-control">
                                    <option value="">-- Select Column --</option>
                                </select>
                                <small style="color: #666; font-size: 11px;">e.g., Region, District, Chiefdom - used for heatmap Y-axis</small>
                            </div>
                            <div class="form-group">
                                <label for="hfColumn">Health Facility Column (hf)</label>
                                <select id="hfColumn" class="form-control">
                                    <option value="">-- Select Column --</option>
                                </select>
                                <small style="color: #666; font-size: 11px;">Used to identify unique facilities</small>
                            </div>
                        </div>
                    </div>

                    <div class="config-card">
                        <h4>Time Period Columns</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="yearColumn">Year Column</label>
                                <select id="yearColumn" class="form-control">
                                    <option value="">-- Select Column --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="monthColumn">Month Column</label>
                                <select id="monthColumn" class="form-control">
                                    <option value="">-- Select Column --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="config-card">
                        <h4>Indicator Columns for Overall Reporting</h4>
                        <p style="font-size: 12px; color: #666; margin-bottom: 1rem;">Select columns to determine if a facility reported (report = 1 if any selected column &gt; 0)</p>
                        <div class="checkbox-group" id="indicatorCheckboxes"></div>
                    </div>

                    <div class="config-card">
                        <h4>Confirmed Cases Column</h4>
                        <p style="font-size: 12px; color: #666; margin-bottom: 1rem;">Select the column for confirmed malaria cases (used for report_conf indicator)</p>
                        <div class="form-group" style="margin-bottom: 0;">
                            <select id="confColumn" class="form-control">
                                <option value="">-- Select Column --</option>
                            </select>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button class="btn btn-primary" onclick="processData()">Process Data</button>
                        <button class="btn btn-secondary" onclick="resetApplication()">Start Over</button>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="hidden">
                    <div class="section-header">
                        <span class="section-icon">2</span>
                        <span class="section-title">RESULTS</span>
                    </div>

                    <div class="stats-grid" id="summaryStats"></div>

                    <div class="config-card">
                        <h4>Download Output Files</h4>
                        <div class="output-list" id="outputList"></div>
                    </div>

                    <div class="section-header" style="margin-top: 2rem;">
                        <span class="section-icon">3</span>
                        <span class="section-title">HEATMAP VISUALIZATION</span>
                    </div>

                    <div class="config-card">
                        <h4>Select Time Aggregation</h4>
                        <div class="form-row">
                            <div class="form-group" style="margin-bottom: 0;">
                                <select id="heatmapLevel" class="form-control" onchange="updateHeatmapOptions()">
                                    <option value="monthly">Monthly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="config-card">
                        <h4>Color Palette <span style="font-size: 11px; color: #28a745; font-weight: 500;">(CB = Colorblind-Friendly)</span></h4>
                        <div class="palette-selector" id="paletteSelector"></div>
                    </div>

                    <div class="config-card">
                        <h4>Customize Labels</h4>
                        <div class="form-row">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="chartTitle">Chart Title</label>
                                <input type="text" id="chartTitle" class="form-control" value="Reporting Rate Heatmap" placeholder="Enter chart title">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="xAxisLabel">X-Axis Label</label>
                                <input type="text" id="xAxisLabel" class="form-control" value="Time Period" placeholder="X-axis label">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="yAxisLabel">Y-Axis Label</label>
                                <input type="text" id="yAxisLabel" class="form-control" value="Location (High to Low)" placeholder="Y-axis label">
                            </div>
                        </div>
                    </div>

                    <div class="config-card">
                        <h4>Image Size</h4>
                        <div class="form-row">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="canvasWidth">Width (pixels)</label>
                                <input type="number" id="canvasWidth" class="form-control" value="900" min="400" max="2000" step="50">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="canvasHeight">Height (pixels)</label>
                                <input type="number" id="canvasHeight" class="form-control" value="700" min="300" max="2000" step="50">
                            </div>
                        </div>
                    </div>

                    <div class="config-card">
                        <h4>Font Sizes</h4>
                        <div class="form-row">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="titleFontSize">Title Size (px)</label>
                                <input type="number" id="titleFontSize" class="form-control" value="18" min="10" max="36" step="1">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="axisLabelFontSize">Axis Label Size (px)</label>
                                <input type="number" id="axisLabelFontSize" class="form-control" value="12" min="8" max="24" step="1">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="tickFontSize">Tick Label Size (px)</label>
                                <input type="number" id="tickFontSize" class="form-control" value="10" min="6" max="18" step="1">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="legendFontSize">Legend Size (px)</label>
                                <input type="number" id="legendFontSize" class="form-control" value="11" min="8" max="18" step="1">
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; margin: 1.5rem 0;">
                        <button class="btn btn-primary" onclick="generateHeatmap()">Generate Heatmap</button>
                    </div>

                    <div class="chart-container hidden" id="chartContainer">
                        <canvas id="heatmapCanvas" class="heatmap-canvas"></canvas>
                    </div>

                    <div style="text-align: center; margin-top: 1.5rem;" id="downloadButtons" class="hidden">
                        <button class="btn btn-success" onclick="downloadHeatmap()">Download Heatmap</button>
                        <button class="btn btn-secondary" onclick="backToConfig()">Back to Settings</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="page-footer">
            <p style="margin: 0; font-weight: 700;">National Malaria Control Programme</p>
            <p>Ministry of Health and Sanitation, Sierra Leone</p>
            <p style="font-size: 10px;">© 2025 Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
        </div>
    </div>

    <script>
        let rawData = null;
        let allColumns = [];
        let selectedPalette = 'viridis';
        
        // Processed data outputs
        let hfWithReports = [];
        let hfNoReports = [];
        let hfReportingMonthly = [];
        let locationReportingMonthly = [];
        let locationReportingYearly = [];

        // Color palettes
        const colorPalettes = {
            viridis: { name: 'Viridis', cbFriendly: true, colors: [[68,1,84],[72,40,120],[62,74,137],[49,104,142],[38,130,142],[31,158,137],[53,183,121],[109,205,89],[180,222,44],[253,231,37]] },
            plasma: { name: 'Plasma', cbFriendly: true, colors: [[13,8,135],[75,3,161],[126,3,168],[168,34,150],[204,71,120],[232,107,90],[250,149,64],[252,194,52],[239,248,33]] },
            cividis: { name: 'Cividis', cbFriendly: true, colors: [[0,32,77],[0,65,108],[59,91,112],[99,113,114],[137,135,114],[176,158,110],[216,183,103],[255,210,93]] },
            blueYellow: { name: 'Blue-Yellow', cbFriendly: true, colors: [[0,68,136],[35,100,150],[70,130,160],[105,160,170],[150,190,180],[195,210,170],[230,220,140],[255,230,90]] },
            redYellowGreen: { name: 'Red-Yellow-Green', cbFriendly: false, colors: [[165,0,38],[215,48,39],[244,109,67],[253,174,97],[254,224,139],[255,255,191],[217,239,139],[166,217,106],[102,189,99],[26,152,80],[0,104,55]] },
            blues: { name: 'Blues', cbFriendly: false, colors: [[247,251,255],[222,235,247],[198,219,239],[158,202,225],[107,174,214],[66,146,198],[33,113,181],[8,81,156],[8,48,107]] },
            greens: { name: 'Greens', cbFriendly: false, colors: [[247,252,245],[229,245,224],[199,233,192],[161,217,155],[116,196,118],[65,171,93],[35,139,69],[0,109,44],[0,68,27]] }
        };

        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.addEventListener('DOMContentLoaded', renderPaletteSelector);

        function renderPaletteSelector() {
            const container = document.getElementById('paletteSelector');
            let html = '';
            Object.entries(colorPalettes).forEach(([key, palette]) => {
                html += `
                    <div class="palette-option ${key === selectedPalette ? 'selected' : ''}" onclick="selectPalette('${key}')" data-palette="${key}">
                        <div class="palette-preview">
                            ${palette.colors.slice(0, 7).map(c => `<div class="color-box" style="background: rgb(${c[0]},${c[1]},${c[2]});"></div>`).join('')}
                        </div>
                        <div class="palette-name">${palette.name}${palette.cbFriendly ? ' (CB)' : ''}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function selectPalette(key) {
            selectedPalette = key;
            document.querySelectorAll('.palette-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.palette === key);
            });
        }

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            if (type === 'success') setTimeout(() => container.innerHTML = '', 5000);
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('loading').classList.remove('hidden');

            try {
                const data = await readFile(file);
                rawData = data;
                allColumns = data.columns;

                document.getElementById('dataStats').innerHTML = `
                    <div class="stats-card"><div class="metric-value">${data.rowCount.toLocaleString()}</div><p>Total Rows</p></div>
                    <div class="stats-card"><div class="metric-value">${data.columns.length}</div><p>Columns</p></div>
                `;

                populateDropdowns();
                populateIndicatorCheckboxes();
                autoSelectColumns();

                document.getElementById('uploadSection').classList.add('hidden');
                document.getElementById('columnSection').classList.remove('hidden');

                showAlert(`File loaded: ${data.rowCount.toLocaleString()} rows, ${data.columns.length} columns`, 'success');
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        async function readFile(file) {
            return new Promise((resolve, reject) => {
                const ext = file.name.toLowerCase().split('.').pop();
                const reader = new FileReader();

                reader.onload = e => {
                    try {
                        let data;
                        if (ext === 'csv') {
                            data = Papa.parse(e.target.result, { header: true, skipEmptyLines: true, dynamicTyping: true }).data;
                        } else if (ext === 'xlsx' || ext === 'xls') {
                            const wb = XLSX.read(e.target.result, { type: 'array' });
                            data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                        } else {
                            reject(new Error(`Unsupported: ${ext}`)); return;
                        }
                        const cleaned = data.filter(row => Object.values(row).some(v => v !== null && v !== undefined && String(v).trim() !== ''));
                        resolve({ name: file.name, data: cleaned, columns: Object.keys(cleaned[0] || {}), rowCount: cleaned.length });
                    } catch (error) { reject(error); }
                };

                reader.onerror = () => reject(new Error('Error reading file'));
                ext === 'csv' ? reader.readAsText(file) : reader.readAsArrayBuffer(file);
            });
        }

        function populateDropdowns() {
            ['locationColumn', 'hfColumn', 'yearColumn', 'monthColumn', 'confColumn'].forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">-- Select Column --</option>' + allColumns.map(col => `<option value="${col}">${col}</option>`).join('');
            });
        }

        function populateIndicatorCheckboxes() {
            const container = document.getElementById('indicatorCheckboxes');
            const defaultIndicators = ['allout', 'susp', 'test', 'conf', 'maltreat'];
            
            container.innerHTML = allColumns.map(col => {
                const isDefault = defaultIndicators.some(ind => col.toLowerCase().includes(ind));
                return `
                    <div class="checkbox-item">
                        <input type="checkbox" id="ind_${col}" value="${col}" ${isDefault ? 'checked' : ''}>
                        <label for="ind_${col}">${col}</label>
                    </div>
                `;
            }).join('');
        }

        function autoSelectColumns() {
            const patterns = {
                locationColumn: ['adm1', 'adm3', 'region', 'district', 'province', 'state', 'lga', 'chiefdom'],
                hfColumn: ['hf', 'facility', 'health_facility', 'healthfacility', 'hf_name'],
                yearColumn: ['year', 'yr'],
                monthColumn: ['month', 'mon', 'mth'],
                confColumn: ['conf', 'confirmed', 'malaria_confirmed']
            };

            allColumns.forEach(col => {
                const colLower = col.toLowerCase();
                Object.entries(patterns).forEach(([selectId, keywords]) => {
                    if (keywords.some(p => colLower.includes(p) || colLower === p)) {
                        const select = document.getElementById(selectId);
                        if (!select.value) select.value = col;
                    }
                });
            });
        }

        function processData() {
            const locationCol = document.getElementById('locationColumn').value;
            const hfCol = document.getElementById('hfColumn').value;
            const yearCol = document.getElementById('yearColumn').value;
            const monthCol = document.getElementById('monthColumn').value;
            const confCol = document.getElementById('confColumn').value;

            // Get selected indicator columns
            const indicatorCols = [];
            document.querySelectorAll('#indicatorCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                indicatorCols.push(cb.value);
            });

            if (!locationCol || !hfCol || !yearCol || !monthCol || !confCol) {
                showAlert('Please select all required columns', 'error');
                return;
            }

            if (indicatorCols.length === 0) {
                showAlert('Please select at least one indicator column', 'error');
                return;
            }

            showAlert('Processing data...', 'info');

            try {
                // Step 1: Calculate overall reporting indicator
                const df = rawData.data.map(row => {
                    const indicatorSum = indicatorCols.reduce((sum, col) => {
                        const val = parseFloat(row[col]) || 0;
                        return sum + val;
                    }, 0);
                    
                    return {
                        ...row,
                        location: row[locationCol],
                        hf: row[hfCol],
                        year: parseInt(row[yearCol]) || 2024,
                        month: parseInt(row[monthCol]) || 1,
                        conf: parseFloat(row[confCol]) || 0,
                        report: indicatorSum > 0 ? 1 : 0
                    };
                });

                // Step 2: Find max report per facility
                const facilityMaxReport = {};
                df.forEach(row => {
                    const key = `${row.location}|${row.hf}`;
                    if (!facilityMaxReport[key]) facilityMaxReport[key] = 0;
                    if (row.report > facilityMaxReport[key]) facilityMaxReport[key] = row.report;
                });

                // Split facilities
                hfWithReports = df.filter(row => {
                    const key = `${row.location}|${row.hf}`;
                    return facilityMaxReport[key] === 1;
                });

                hfNoReports = df.filter(row => {
                    const key = `${row.location}|${row.hf}`;
                    return facilityMaxReport[key] === 0;
                });

                // Step 3: Calculate report_conf indicator
                hfWithReports = hfWithReports.map(row => ({
                    ...row,
                    report_conf: row.conf > 0 ? 1 : 0,
                    date: `${row.year}-${String(row.month).padStart(2, '0')}`
                }));

                // Step 4: Find first month each facility reported
                const facilityFirstMonth = {};
                hfWithReports.forEach(row => {
                    const key = `${row.location}|${row.hf}`;
                    if (!facilityFirstMonth[key] || row.date < facilityFirstMonth[key]) {
                        facilityFirstMonth[key] = row.date;
                    }
                });

                // Calculate expected to report
                hfReportingMonthly = hfWithReports.map(row => {
                    const key = `${row.location}|${row.hf}`;
                    const firstMonth = facilityFirstMonth[key];
                    return {
                        ...row,
                        First_month_hf_reported: firstMonth,
                        do_hf_expected_to_report_per_month: row.date >= firstMonth ? 1 : 0
                    };
                });

                // Step 5: Aggregate by location and date
                const locationDateAgg = {};
                hfReportingMonthly.forEach(row => {
                    const key = `${row.location}|${row.date}`;
                    if (!locationDateAgg[key]) {
                        locationDateAgg[key] = { location: row.location, date: row.date, report_conf_sum: 0, hf_expected_sum: 0 };
                    }
                    locationDateAgg[key].report_conf_sum += row.report_conf;
                    locationDateAgg[key].hf_expected_sum += row.do_hf_expected_to_report_per_month;
                });

                locationReportingMonthly = Object.values(locationDateAgg).map(row => ({
                    ...row,
                    reporting_rate: row.hf_expected_sum > 0 ? Math.round((row.report_conf_sum / row.hf_expected_sum) * 10000) / 100 : 0
                })).sort((a, b) => a.location.localeCompare(b.location) || a.date.localeCompare(b.date));

                // Aggregate by location and year
                const locationYearAgg = {};
                hfReportingMonthly.forEach(row => {
                    const key = `${row.location}|${row.year}`;
                    if (!locationYearAgg[key]) {
                        locationYearAgg[key] = { location: row.location, year: row.year, report_conf_sum: 0, hf_expected_sum: 0 };
                    }
                    locationYearAgg[key].report_conf_sum += row.report_conf;
                    locationYearAgg[key].hf_expected_sum += row.do_hf_expected_to_report_per_month;
                });

                locationReportingYearly = Object.values(locationYearAgg).map(row => ({
                    ...row,
                    reporting_rate: row.hf_expected_sum > 0 ? Math.round((row.report_conf_sum / row.hf_expected_sum) * 10000) / 100 : 0
                })).sort((a, b) => a.location.localeCompare(b.location) || a.year - b.year);

                // Calculate summary statistics
                const uniqueFacilitiesWithReports = new Set(hfWithReports.map(r => `${r.location}|${r.hf}`)).size;
                const uniqueFacilitiesNoReports = new Set(hfNoReports.map(r => `${r.location}|${r.hf}`)).size;
                const totalConfirmed = hfReportingMonthly.reduce((s, r) => s + r.report_conf, 0);
                const totalExpected = hfReportingMonthly.reduce((s, r) => s + r.do_hf_expected_to_report_per_month, 0);
                const overallRate = totalExpected > 0 ? Math.round((totalConfirmed / totalExpected) * 10000) / 100 : 0;
                const uniqueLocations = new Set(hfReportingMonthly.map(r => r.location)).size;

                document.getElementById('summaryStats').innerHTML = `
                    <div class="stats-card"><div class="metric-value">${uniqueLocations}</div><p>Locations</p></div>
                    <div class="stats-card"><div class="metric-value">${uniqueFacilitiesWithReports.toLocaleString()}</div><p>Facilities With Reports</p></div>
                    <div class="stats-card"><div class="metric-value">${uniqueFacilitiesNoReports.toLocaleString()}</div><p>Facilities No Reports</p></div>
                    <div class="stats-card"><div class="metric-value">${totalConfirmed.toLocaleString()}</div><p>Total Confirmed</p></div>
                    <div class="stats-card"><div class="metric-value">${totalExpected.toLocaleString()}</div><p>Total Expected</p></div>
                    <div class="stats-card"><div class="metric-value">${overallRate}%</div><p>Overall Rate</p></div>
                `;

                // Render output files list
                renderOutputList();

                document.getElementById('columnSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');

                showAlert('Data processed successfully!', 'success');

            } catch (error) {
                showAlert(`Processing error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function renderOutputList() {
            const outputs = [
                { name: 'hf_with_reports.xlsx', data: hfWithReports, desc: 'Facilities with at least one report' },
                { name: 'hf_no_reports.xlsx', data: hfNoReports, desc: 'Facilities with no reports' },
                { name: 'hf_reporting_monthly.xlsx', data: hfReportingMonthly, desc: 'Monthly HF reporting data' },
                { name: 'location_reporting_monthly.xlsx', data: locationReportingMonthly, desc: 'Location monthly reporting rates' },
                { name: 'location_reporting_yearly.xlsx', data: locationReportingYearly, desc: 'Location yearly reporting rates' }
            ];

            document.getElementById('outputList').innerHTML = outputs.map((out, idx) => `
                <div class="output-item">
                    <span><strong>${out.name}</strong> - ${out.desc} (${out.data.length.toLocaleString()} rows)</span>
                    <button class="btn btn-success" onclick="downloadExcel(${idx})">Download</button>
                </div>
            `).join('');
        }

        function downloadExcel(index) {
            const outputs = [
                { name: 'hf_with_reports.xlsx', data: hfWithReports },
                { name: 'hf_no_reports.xlsx', data: hfNoReports },
                { name: 'hf_reporting_monthly.xlsx', data: hfReportingMonthly },
                { name: 'location_reporting_monthly.xlsx', data: locationReportingMonthly },
                { name: 'location_reporting_yearly.xlsx', data: locationReportingYearly }
            ];

            const output = outputs[index];
            const ws = XLSX.utils.json_to_sheet(output.data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
            XLSX.writeFile(wb, output.name);
            showAlert(`Downloaded: ${output.name}`, 'success');
        }

        function updateHeatmapOptions() {
            const level = document.getElementById('heatmapLevel').value;
            document.getElementById('xAxisLabel').value = level === 'yearly' ? 'Year' : 'Time Period (YYYY-MM)';
        }

        function generateHeatmap() {
            const level = document.getElementById('heatmapLevel').value;
            let data, timeKey;

            if (level === 'monthly') {
                data = locationReportingMonthly;
                timeKey = 'date';
            } else {
                data = locationReportingYearly;
                timeKey = 'year';
            }

            if (!data || data.length === 0) {
                showAlert('No data available for heatmap', 'error');
                return;
            }

            drawHeatmap(data, 'location', timeKey);
            document.getElementById('chartContainer').classList.remove('hidden');
            document.getElementById('downloadButtons').classList.remove('hidden');
        }

        function drawHeatmap(data, locationKey, timeKey) {
            const canvas = document.getElementById('heatmapCanvas');
            const ctx = canvas.getContext('2d');

            // Get configuration values
            const chartTitle = document.getElementById('chartTitle').value || 'Reporting Rate Heatmap';
            const xAxisLabel = document.getElementById('xAxisLabel').value || 'Time Period';
            const yAxisLabel = document.getElementById('yAxisLabel').value || 'Location (High to Low)';
            
            // Image size
            const canvasWidth = parseInt(document.getElementById('canvasWidth').value) || 900;
            const canvasHeight = parseInt(document.getElementById('canvasHeight').value) || 700;
            const leftMargin = 50;
            
            // Font sizes
            const titleFontSize = parseInt(document.getElementById('titleFontSize').value) || 18;
            const axisLabelFontSize = parseInt(document.getElementById('axisLabelFontSize').value) || 12;
            const tickFontSize = parseInt(document.getElementById('tickFontSize').value) || 10;
            const legendFontSize = parseInt(document.getElementById('legendFontSize').value) || 11;

            // Get unique time periods
            const times = [...new Set(data.map(r => String(r[timeKey])))].sort();

            // Calculate average rate per location and sort
            const locationData = {};
            data.forEach(row => {
                const loc = row[locationKey];
                if (!locationData[loc]) locationData[loc] = { values: {}, total: 0, count: 0 };
                locationData[loc].values[String(row[timeKey])] = row.reporting_rate;
                locationData[loc].total += row.reporting_rate;
                locationData[loc].count++;
            });

            const locationAvgs = Object.entries(locationData).map(([loc, d]) => ({
                location: loc,
                avgRate: d.total / d.count,
                values: d.values
            }));

            locationAvgs.sort((a, b) => b.avgRate - a.avgRate);
            const sortedLocations = locationAvgs.map(l => l.location);

            // Canvas dimensions
            const margins = { top: 100, bottom: 80, left: leftMargin, right: 30 };
            const heatmapWidth = canvasWidth - margins.left - margins.right;
            const heatmapHeight = canvasHeight - margins.top - margins.bottom;
            const cellWidth = heatmapWidth / times.length;
            const cellHeight = heatmapHeight / sortedLocations.length;

            canvas.width = canvasWidth;
            canvas.height = canvasHeight;

            // Background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            const startX = margins.left;
            const startY = margins.top;

            // Title
            ctx.fillStyle = '#004080';
            ctx.font = `bold ${titleFontSize}px Oswald, sans-serif`;
            ctx.textAlign = 'center';
            ctx.fillText(chartTitle, canvasWidth / 2, 25);

            // Legend
            const legendY = 45;
            const legendWidth = 280;
            const gradientStartX = (canvasWidth - legendWidth) / 2;

            ctx.fillStyle = '#f8f9fa';
            ctx.strokeStyle = '#004080';
            ctx.lineWidth = 1;
            ctx.fillRect(gradientStartX - 20, legendY - 5, legendWidth + 40, 45);
            ctx.strokeRect(gradientStartX - 20, legendY - 5, legendWidth + 40, 45);

            ctx.fillStyle = '#004080';
            ctx.font = `bold ${legendFontSize}px Oswald, sans-serif`;
            ctx.fillText('Reporting Rate (%)', canvasWidth / 2, legendY + 8);

            for (let i = 0; i <= legendWidth; i++) {
                ctx.fillStyle = getColorFromPalette(i / legendWidth);
                ctx.fillRect(gradientStartX + i, legendY + 15, 1, 12);
            }

            ctx.strokeStyle = '#004080';
            ctx.strokeRect(gradientStartX, legendY + 15, legendWidth, 12);

            ctx.fillStyle = '#000';
            ctx.font = `${legendFontSize - 2}px Oswald, sans-serif`;
            [0, 25, 50, 75, 100].forEach(tick => {
                ctx.fillText(`${tick}%`, gradientStartX + (tick / 100) * legendWidth, legendY + 38);
            });

            // Y-axis title
            ctx.save();
            ctx.translate(15, startY + heatmapHeight / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillStyle = '#004080';
            ctx.font = `bold ${axisLabelFontSize}px Oswald, sans-serif`;
            ctx.textAlign = 'center';
            ctx.fillText(yAxisLabel, 0, 0);
            ctx.restore();

            // X-axis title
            ctx.fillStyle = '#004080';
            ctx.font = `bold ${axisLabelFontSize}px Oswald, sans-serif`;
            ctx.textAlign = 'center';
            ctx.fillText(xAxisLabel, startX + heatmapWidth / 2, canvasHeight - 10);

            // Draw cells
            sortedLocations.forEach((location, locIdx) => {
                const locData = locationData[location];
                times.forEach((time, timeIdx) => {
                    const value = locData.values[time] || 0;
                    const cellX = startX + timeIdx * cellWidth;
                    const cellY = startY + locIdx * cellHeight;

                    ctx.fillStyle = getColorFromPalette(value / 100);
                    ctx.fillRect(cellX, cellY, cellWidth + 0.5, cellHeight + 0.5);
                });
            });

            // X-axis labels
            ctx.textAlign = 'right';
            ctx.font = `${tickFontSize}px Oswald, sans-serif`;
            const labelStep = Math.max(1, Math.ceil(times.length / 20));
            times.forEach((time, idx) => {
                if (idx % labelStep === 0) {
                    const labelX = startX + idx * cellWidth + cellWidth / 2;
                    ctx.save();
                    ctx.translate(labelX + 3, startY + heatmapHeight + 10);
                    ctx.rotate(-Math.PI / 2);
                    ctx.fillText(time, 0, 0);
                    ctx.restore();
                }
            });

            // Info
            ctx.fillStyle = '#666';
            ctx.font = `${tickFontSize - 1}px Oswald, sans-serif`;
            ctx.textAlign = 'right';
            ctx.fillText(`${sortedLocations.length} locations × ${times.length} periods`, canvasWidth - 5, canvasHeight - 3);
        }

        function getColorFromPalette(t) {
            t = Math.max(0, Math.min(1, t));
            const palette = colorPalettes[selectedPalette];
            const colors = palette.colors;

            const index = t * (colors.length - 1);
            const lower = Math.floor(index);
            const upper = Math.ceil(index);
            const ratio = index - lower;

            if (lower === upper) {
                return `rgb(${colors[lower][0]}, ${colors[lower][1]}, ${colors[lower][2]})`;
            }

            const r = Math.round(colors[lower][0] * (1 - ratio) + colors[upper][0] * ratio);
            const g = Math.round(colors[lower][1] * (1 - ratio) + colors[upper][1] * ratio);
            const b = Math.round(colors[lower][2] * (1 - ratio) + colors[upper][2] * ratio);

            return `rgb(${r}, ${g}, ${b})`;
        }

        function downloadHeatmap() {
            const canvas = document.getElementById('heatmapCanvas');
            const link = document.createElement('a');
            const title = document.getElementById('chartTitle').value || 'reporting_rate_heatmap';
            link.download = title.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            showAlert('Heatmap downloaded!', 'success');
        }

        function backToConfig() {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('columnSection').classList.remove('hidden');
        }

        function resetApplication() {
            rawData = null;
            allColumns = [];
            hfWithReports = [];
            hfNoReports = [];
            hfReportingMonthly = [];
            locationReportingMonthly = [];
            locationReportingYearly = [];
            selectedPalette = 'viridis';

            document.getElementById('fileInput').value = '';
            document.getElementById('chartTitle').value = 'Reporting Rate Heatmap';
            document.getElementById('xAxisLabel').value = 'Time Period';
            document.getElementById('yAxisLabel').value = 'Location (High to Low)';
            
            // Reset size settings
            document.getElementById('canvasWidth').value = '900';
            document.getElementById('canvasHeight').value = '700';
            
            // Reset font settings
            document.getElementById('titleFontSize').value = '18';
            document.getElementById('axisLabelFontSize').value = '12';
            document.getElementById('tickFontSize').value = '10';
            document.getElementById('legendFontSize').value = '11';

            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('columnSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('chartContainer').classList.add('hidden');
            document.getElementById('downloadButtons').classList.add('hidden');
            document.getElementById('alertContainer').innerHTML = '';

            renderPaletteSelector();
        }
    </script>
</body>
</html>
